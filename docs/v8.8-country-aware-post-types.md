# Social Echo v8.8: Country-Aware Post Types & Diversity Engine

## Overview

Version 8.8 introduces major enhancements to Social Echo's content generation system, focusing on **localization**, **content diversity**, and **post type restructuring**. These changes ensure generated content is more relevant, less repetitive, and better tailored to users' geographic markets.

## Key Features

### 1. Country-Aware Content Generation

Users can now specify their country in the "Train Your Echo" form. This enables:

- **Localized spelling**: UK English (colour, favourite) vs US English (color, favorite)
- **Currency symbols**: Â£ (UK), $ (US/CA/AU), â‚¬ (IE), â‚¹ (IN), R (ZA)
- **Cultural references**: Holidays, observances, and business practices relevant to the user's market
- **News relevance**: Prioritizes country-specific news when available

**Supported Countries:**
- ðŸ‡¬ðŸ‡§ United Kingdom
- ðŸ‡ºðŸ‡¸ United States
- ðŸ‡¨ðŸ‡¦ Canada
- ðŸ‡¦ðŸ‡º Australia
- ðŸ‡®ðŸ‡ª Ireland
- ðŸ‡³ðŸ‡¿ New Zealand
- ðŸ‡®ðŸ‡³ India
- ðŸ‡¿ðŸ‡¦ South Africa
- Other (neutral international English)

### 2. Post Type Restructure

Post types have been reorganized for better clarity and functionality:

| Old Types | New Type | Display Label | Icon |
|-----------|----------|---------------|------|
| `informational` + `advice` | `information_advice` | Information & Advice | ðŸ’¡ |
| *(new)* | `random` | Random / Fun Facts | ðŸŽ² |
| `selling` | `selling` | Selling | ðŸ’° |
| `news` | `news` | News | ðŸ“° |

**Backward Compatibility:**
- Existing posts with `informational` or `advice` types display as "Information & Advice"
- No database rewrites required - mapping happens at render time
- History and analytics remain intact

### 3. Diversity Engine

The new diversity engine reduces repetition and increases content freshness through:

#### Style Rotation
Automatically rotates between 4 brand tones:
- **Friendly** - Warm and approachable
- **Witty** - Clever and playful
- **Professional** - Formal and authoritative
- **Bold** - Direct and opinionated

#### Hook Templates
15 varied opening templates to avoid repetitive starts:
- "Did you know..."
- "Pro tip:"
- "Here's what most people miss:"
- "Unpopular opinion:"
- "Quick win:"
- And 10 more...

#### Phrase Ban List
Automatically avoids 20+ overused business buzzwords:
- "game changer"
- "paradigm shift"
- "synergy"
- "leverage"
- "low-hanging fruit"
- And more...

#### N-Gram De-duplication
- Analyzes last 20 posts for trigram (3-word sequence) overlap
- Flags posts with >30% max overlap or >15% average overlap
- Provides feedback for regeneration if needed

#### 3-Variant Generation Mode
*(Optional, for future enhancement)*
- Generates 3 variants with different seeds
- Scores each variant on freshness and banned phrase avoidance
- Automatically selects the best variant

### 4. Enhanced Data Sources

#### Random Data Module (`lib/ai/random-data.ts`)
Provides content sources for "Random / Fun Facts" posts:
- **World observances**: International Coffee Day, World Productivity Day, etc.
- **Country-specific observances**: National Tea Day (UK), Small Business Saturday (US/UK)
- **Science facts**: Zeigarnik Effect, Parkinson's Law, Dunning-Kruger Effect
- **Pop culture**: Film and TV references (The Godfather, Star Wars, The Office)
- **History**: "This Day in History" for tech/business milestones
- **Holidays**: Boxing Day (UK), Thanksgiving (US), etc.

**Total sources**: 40+ unique content hooks

#### News Provider Module (`lib/ai/news-provider.ts`)
Curated news snippets for News posts:
- **Sector relevance scoring**: Matches news to user's industry
- **Country filtering**: Prioritizes UK/US/world news based on profile
- **12 evergreen snippets**: Covers tech, SME, retail, HR, marketing, cybersecurity
- **Fallback handling**: Gracefully handles when no relevant news is found
- **Designed for API replacement**: Easy to swap with live news API in future

## Architecture

### New Modules

```
lib/
â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ prompt-builder.ts        # Country-aware prompts for all post types
â”‚   â”œâ”€â”€ diversity.ts              # Style rotation, repetition checking, phrase banning
â”‚   â”œâ”€â”€ random-data.ts            # Observances, facts, pop culture, history
â”‚   â”œâ”€â”€ news-provider.ts          # Curated news snippets by sector + country
â”‚   â”œâ”€â”€ ai-service-v8.8.ts        # New generation service with v8.8 features
â”‚   â””â”€â”€ ai-service.ts             # Legacy service (updated ProfileData type)
â””â”€â”€ post-type-mapping.ts          # Backward-compatible post type display

prisma/
â””â”€â”€ migrations/
    â””â”€â”€ 20251022125912_add_country_to_profile/
        â””â”€â”€ migration.sql         # Adds country column to Profile table
```

### Generation Flow (v8.8)

```
User triggers generation
  â†“
API route (generate-text/route.ts)
  â†“
Feature flag check (USE_V8_8_GENERATION)
  â†“
buildAndGenerateDraftV8()
  â†“
1. Load AI config from database
2. Normalize post type (handle legacy keys)
3. Determine effective tone
4. Generate diversity parameters (style, hook, temperature, top_p)
5. Build GenInputs with country
6. Build prompt based on post type:
   - Selling â†’ buildSellingPrompt()
   - Information & Advice â†’ buildInfoAdvicePrompt()
   - Random / Fun Facts â†’ buildRandomPrompt() + pickRandomSource()
   - News â†’ buildNewsPrompt() + getCuratedNews()
7. Call AI model (OpenAI/Anthropic)
8. Parse JSON response
9. Check repetition and banned phrases
10. Return GeneratedDraft
```

### Database Schema Changes

**Profile table** - Added optional `country` field:

```sql
ALTER TABLE "Profile" ADD COLUMN "country" TEXT;
```

**No breaking changes** - Existing profiles work without country (defaults to neutral international English)

## UI Changes

### Train Your Echo Form
- New **Country** dropdown after "Content Rotation"
- Flag emojis for visual clarity
- Helpful description about localization benefits
- Optional field - can be left blank

### Dashboard (TodayPanel)
- Post type buttons now show icons + display labels
  - ðŸ’° Selling
  - ðŸ’¡ Information & Advice
  - ðŸŽ² Random / Fun Facts
  - ðŸ“° News
- Post type badge shows icon + mapped label
- Backward compatible with legacy post types

### History Drawer
- Post type display uses mapping function
- Shows icon + display label for all posts
- Legacy posts display with new labels

### Fine-Tune Panel
- Updated post type buttons with icons
- Consistent with TodayPanel styling

## API Changes

### Profile API (`/api/profile`)
- **GET**: Returns `country` field (null if not set)
- **POST**: Accepts optional `country` in ProfileSchema
- **Validation**: Uses Zod schema with `.optional()`

### Generate Text API (`/api/generate-text`)
- **Feature flag**: `USE_V8_8_GENERATION` (default: `true`)
- **v8.8 mode**: Uses `buildAndGenerateDraftV8()` with diversity engine
- **Legacy mode**: Falls back to `buildAndGenerateDraft()` if flag is `false`
- **ProfileData**: Includes `country` field

## Configuration

### Feature Flag

To switch between v8.8 and legacy generation:

```typescript
// app/api/generate-text/route.ts
const USE_V8_8_GENERATION = true  // Set to false to use legacy
```

### Diversity Engine

To disable diversity engine for specific generation:

```typescript
const draft = await buildAndGenerateDraftV8({
  userId,
  postType,
  profile,
  useDiversityEngine: false  // Disable style rotation and repetition checks
})
```

## Testing Recommendations

### Manual Testing

1. **Country awareness**:
   - Create UK profile â†’ Check for UK spelling, Â£ currency, UK holidays
   - Create US profile â†’ Check for US spelling, $ currency, US holidays
   - Leave country blank â†’ Check for neutral international English

2. **Post types**:
   - Generate "Information & Advice" â†’ Should merge old informational + advice logic
   - Generate "Random / Fun Facts" â†’ Should use random data sources
   - Generate "News" â†’ Should use curated news snippets
   - Generate "Selling" â†’ Should maintain PAS structure

3. **Diversity engine**:
   - Generate 5+ posts â†’ Check for style variation (friendly, witty, professional, bold)
   - Check for varied opening hooks
   - Verify no banned phrases in output
   - Compare posts for trigram overlap

4. **Backward compatibility**:
   - View history with old `informational` posts â†’ Should display as "Information & Advice"
   - View history with old `advice` posts â†’ Should display as "Information & Advice"
   - Verify analytics still work

### Automated Testing

```bash
# Run type checks
pnpm tsc --noEmit

# Run database migration (development)
pnpm prisma migrate dev

# Generate Prisma client
pnpm prisma generate

# Test profile API
curl -X POST http://localhost:3000/api/profile \
  -H "Content-Type: application/json" \
  -d '{"business_name":"Test","industry":"Tech","country":"United Kingdom",...}'

# Test generation API
curl -X POST http://localhost:3000/api/generate-text \
  -H "Content-Type: application/json" \
  -d '{"post_type":"random","tone":"professional",...}'
```

## Migration Guide

### For Existing Users

**No action required** - The v8.8 update is fully backward compatible:

1. Existing profiles without `country` will use neutral international English
2. Old post types (`informational`, `advice`) display with new labels
3. Post history and analytics remain unchanged
4. Users can add country anytime by editing their profile

### For Developers

1. **Pull latest code**:
   ```bash
   git pull origin main
   ```

2. **Install dependencies**:
   ```bash
   pnpm install
   ```

3. **Run migration**:
   ```bash
   pnpm prisma migrate deploy  # Production
   pnpm prisma migrate dev     # Development
   ```

4. **Generate Prisma client**:
   ```bash
   pnpm prisma generate
   ```

5. **Restart application**:
   ```bash
   # Render will auto-deploy on push to main
   # Local: pnpm dev
   ```

## Rollback Plan

If issues arise, rollback is straightforward:

1. **Disable v8.8 generation**:
   ```typescript
   const USE_V8_8_GENERATION = false
   ```

2. **Revert to previous commit**:
   ```bash
   git revert <commit-hash>
   git push origin main
   ```

3. **Database rollback** (if needed):
   ```sql
   ALTER TABLE "Profile" DROP COLUMN "country";
   ```

**Note**: Post type mapping is render-time only, so no database rollback needed for that.

## Future Enhancements

### Phase 2 (Future)
- **Live news API integration**: Replace curated snippets with real-time news
- **More countries**: Add support for more regions
- **3-variant generation**: Enable multi-variant generation with automatic selection
- **A/B testing**: Test v8.8 vs legacy with subset of users
- **Diversity scoring dashboard**: Show users their content diversity metrics

### Phase 3 (Future)
- **AI-powered country detection**: Auto-detect country from profile data
- **Custom observances**: Allow users to add their own industry-specific dates
- **Advanced repetition detection**: Semantic similarity beyond trigrams
- **Style preferences**: Let users favorite certain styles for more frequent use

## Support

For questions or issues:
- **GitHub Issues**: https://github.com/H6gvbhYujnhwP/social-echo/issues
- **Email**: support@socialecho.ai
- **Help Page**: https://www.socialecho.ai/help

## Changelog

### v8.8.0 (2025-10-22)

**Added:**
- Country field to Profile model and Train Your Echo form
- Post type restructure: Information & Advice, Random / Fun Facts
- Diversity engine with style rotation and repetition checking
- Random data module with 40+ content sources
- News provider module with curated snippets
- Country-aware prompt builder for all post types
- Post type mapping utility for backward compatibility
- Feature flag for gradual v8.8 rollout

**Changed:**
- ProfileData type now includes optional `country` field
- Post type buttons show icons + display labels
- History displays mapped post type labels

**Fixed:**
- N/A (new feature release)

**Deprecated:**
- N/A

**Removed:**
- N/A

**Security:**
- N/A

