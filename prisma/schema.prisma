// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles for RBAC
enum UserRole {
  USER
  ADMIN
  MASTER_ADMIN
}

// User authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    // bcrypt hashed
  emailVerified DateTime?
  role          UserRole  @default(USER)
  
  // 2FA
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  
  // Relations
  profile              Profile?
  subscription         Subscription?
  postHistory          PostHistory[]
  feedback             Feedback[]
  plannerDays          PlannerDay[]
  passwordResetTokens  PasswordResetToken[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// User business profile (matches localStorage UserProfile)
model Profile {
  id               String   @id @default(cuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Core profile fields (matching localStorage exactly)
  business_name     String
  website           String
  industry          String
  tone              String   // 'professional' | 'casual' | 'funny' | 'bold'
  products_services String
  target_audience   String
  usp               String   // Unique Selling Point
  keywords          String[] // Array of keywords
  rotation          String   // 'serious' | 'quirky'
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
}

// Subscriptions & usage limits
model Subscription {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  plan       String   @default("starter") // "starter" | "pro" | "enterprise"
  status     String   @default("active")  // "active" | "canceled" | "trialing"
  
  // Usage tracking
  usageCount Int      @default(0)  // Posts generated this month
  usageLimit Int      @default(8)  // 8 for starter, higher for pro/enterprise
  
  // Billing period
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  
  // Stripe integration (for future)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// Content planner schedule (matches localStorage Planner)
model PlannerDay {
  id       String  @id @default(cuid())
  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  day      String  // 'mon' | 'tue' | 'wed' | 'thu' | 'fri' | 'sat' | 'sun'
  type     String  // 'selling' | 'informational' | 'advice' | 'news'
  enabled  Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, day])
  @@index([userId])
}

// Post generation history (matches localStorage PostHistory)
model PostHistory {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date     String   // YYYY-MM-DD
  postType String   // 'selling' | 'informational' | 'advice' | 'news'
  tone     String   // 'professional' | 'casual' | 'funny' | 'bold'
  
  // Generated content
  headlineOptions String[] // Array of headline options
  postText        String   @db.Text
  hashtags        String[] // Array of hashtags
  visualPrompt    String   @db.Text
  
  // Metadata
  isRegeneration Boolean  @default(false)
  
  // Relations
  feedback Feedback?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// Feedback on posts (matches localStorage PostFeedback)
model Feedback {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId   String   @unique
  post     PostHistory @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  feedback String   // 'up' | 'down'
  note     String?  @db.Text
  
  // Context at time of feedback
  postType String   // 'selling' | 'informational' | 'advice' | 'news'
  tone     String   // 'professional' | 'casual' | 'funny' | 'bold'
  keywords String[] // Keywords from profile at time of feedback
  hashtags String[] // Hashtags from the post
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([postId])
}

// Admin configuration storage
model AdminConfig {
  id        String   @id @default(cuid())
  key       String   @unique  // e.g., 'ai_globals'
  json      Json                // Configuration object
  updatedBy String?             // User ID who last updated
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([key])
}

// Admin configuration change history
model AdminConfigHistory {
  id        String   @id @default(cuid())
  key       String              // Config key (e.g., 'ai_globals')
  json      Json                // Configuration snapshot
  updatedBy String              // User ID who made the change
  reason    String?  @db.Text   // Optional reason for change
  
  createdAt DateTime @default(now())
  
  @@index([key])
  @@index([createdAt])
}
